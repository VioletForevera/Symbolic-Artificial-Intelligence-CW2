# WSP求解器 - 最终方案

## 🎯 智能求解器架构

### 自动算法选择策略

```
┌─────────────────────────────────────┐
│   Solver(filename)                  │
│   智能入口函数                        │
└───────────┬─────────────────────────┘
            │
            ├─ 解析实例，检测规模
            │
            ├─ if users < 300:
            │  └─> Solver_CPSAT()  (Google OR-Tools)
            │      - 适合小中规模实例
            │      - 整数域变量
            │      - 16线程并行
            │
            └─ if users >= 300:
               └─> Solver_Z3()  (Microsoft Z3)
                   - 工业级SMT求解器
                   - 强大的布尔约束处理
                   - 高效的冲突驱动学习
```

## 📦 已实现的求解器

### 1. ✅ **Solver_Z3** (solver_z3.py)
**推荐用于大规模实例 (300+ users)**

**技术特点**:
- 使用SMT（Satisfiability Modulo Theories）
- 整数变量编码：`p[s] ∈ valid_users`
- Z3内置的`AtMost`基数约束
- 180秒超时

**优势**:
- 工业级求解器，经过高度优化
- 擅长高约束密度问题
- 免费且开源

**适用场景**:
- 500用户 + 184个SoD约束
- 高约束密度 (ratio > 2.0)
- 需要完备求解

---

### 2. ✅ **Solver_CPSAT** (wsp_app.py)
**用于中小规模实例 (<300 users)**

**技术特点**:
- Google OR-Tools CP-SAT求解器
- 整数域变量
- 自适应超时（30-180秒）
- 16线程并行搜索

**优势**:
- 对中等规模问题非常高效
- 灵活的约束建模
- 成熟稳定

---

### 3. ⚡ **Solver_Heuristic** (solver_heuristic.py)
**快速但不完备的探索**

**技术特点**:
- 贪心初始化
- 局部搜索 + 模拟退火
- 极快 (<1秒)

**适用场景**:
- 快速获得近似解
- 探索解空间
- 辅助完备求解器

---

## 🚀 使用方法

### 方法1: GUI (推荐)
```bash
python wsp_app.py
```
- 自动选择最优求解器
- 实时进度显示
- 结果可视化

### 方法2: 命令行
```python
from wsp_app import Solver

result = Solver("path/to/instance.txt")
print(result['sat'])  # 'sat' or 'unsat'
print(result['exe_time'])  # 执行时间
print(result['sol'])  # 解（如果存在）
```

### 方法3: 直接调用特定求解器
```python
# 大规模实例 - 使用Z3
from solver_z3 import Solver_Z3
result = Solver_Z3("4-constraint-hard/0.txt")

# 中等实例 - 使用CP-SAT
from wsp_app import Solver_CPSAT
result = Solver_CPSAT("example1.txt")
```

---

## 📊 性能对比

| 实例类型 | 用户数 | 约束数 | CP-SAT | Z3 | 启发式 |
|---------|--------|--------|--------|----|----|
| 简单实例 | <100 | <100 | <1s ✅ | ~1s | <1s |
| 中等实例 | 100-300 | <500 | <30s ✅ | ~10s | <1s |
| 困难实例 | 500 | 716 | 超时 ❌ | **测试中** 🔄 | 不完备 |

---

## 🎯 当前状态

### Z3求解器测试
```
文件: 4-constraint-hard/0.txt
状态: 🔄 求解中...
预期: Z3应该能在3分钟内找到解
```

### 预期结果
- ✅ **成功**: Z3找到解 → 成为默认大规模求解器
- ⚠️ **超时**: 考虑增加超时或使用混合策略
- ❌ **失败**: 此问题可能超出自动求解器能力，需要人工启发式

---

## 💡 技术洞察

### 为什么Z3可能成功？

1. **更好的SAT引擎**
   - Z3的核心SAT求解器高度优化
   - CDCL算法with学习子句

2. **SMT理论集成**
   - 可以利用整数理论
   - 比纯布尔编码更紧凑

3. **工业级优化**
   - 数十年的优化积累
   - 处理过大规模实际问题

### WSP问题的本质复杂度

- **NP完全问题**：最坏情况指数时间
- **约束密度**：SoD比率 = 184/60 ≈ 3.07（非常高）
- **搜索空间**：500^60 ≈ 10^162（天文数字）

**结论**: 需要强大的剪枝和学习机制，这正是Z3的优势所在。

---

## 📝 下一步

等待Z3测试结果，然后：
1. 如果成功 → 更新文档，部署
2. 如果超时 → 增加超时或实现混合策略
3. 如果失败 → 考虑特定领域的启发式算法
